{
  "version": 3,
  "sources": ["../../../r2-worker.js"],
  "sourceRoot": "C:\\Users\\yavuz\\OneDrive\\Masa\u00FCst\u00FC\\Longhorn\\lethrinus-dashboard\\cloudflare-worker\\.wrangler\\tmp\\deploy-qxU5Cf",
  "sourcesContent": ["/**\r\n * Cloudflare R2 Storage Worker\r\n * \r\n * This worker handles file uploads, downloads, and management for R2 storage.\r\n * Deploy this to Cloudflare Workers and bind your R2 bucket.\r\n * \r\n * SETUP INSTRUCTIONS:\r\n * 1. Create a Cloudflare Workers project: `npx wrangler init r2-storage-worker`\r\n * 2. Copy this file as `src/index.js`\r\n * 3. Update `wrangler.toml` with the configuration below\r\n * 4. Deploy: `npx wrangler deploy`\r\n * \r\n * wrangler.toml configuration:\r\n * ```\r\n * name = \"r2-storage-worker\"\r\n * main = \"src/index.js\"\r\n * compatibility_date = \"2024-01-01\"\r\n * \r\n * [[r2_buckets]]\r\n * binding = \"R2_BUCKET\"\r\n * bucket_name = \"your-bucket-name\"\r\n * \r\n * [vars]\r\n * ALLOWED_ORIGINS = \"https://your-app-domain.com,http://localhost:5173\"\r\n * AUTH_SECRET = \"your-secret-key-for-auth\"\r\n * ```\r\n */\r\n\r\nexport default {\r\n    async fetch(request, env, ctx) {\r\n        // CORS handling\r\n        const corsHeaders = {\r\n            'Access-Control-Allow-Origin': getAllowedOrigin(request, env),\r\n            'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n            'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n            'Access-Control-Max-Age': '86400',\r\n        };\r\n\r\n        // Handle preflight\r\n        if (request.method === 'OPTIONS') {\r\n            return new Response(null, { headers: corsHeaders });\r\n        }\r\n\r\n        const url = new URL(request.url);\r\n        const path = url.pathname;\r\n\r\n        try {\r\n            // Route handling\r\n            if (path === '/upload' && request.method === 'POST') {\r\n                return await handleUpload(request, env, corsHeaders);\r\n            }\r\n            \r\n            if (path === '/delete' && request.method === 'DELETE') {\r\n                return await handleDelete(request, env, corsHeaders);\r\n            }\r\n            \r\n            if (path === '/signed-url' && request.method === 'GET') {\r\n                return await handleSignedUrl(request, env, corsHeaders);\r\n            }\r\n            \r\n            if (path === '/list' && request.method === 'GET') {\r\n                return await handleList(request, env, corsHeaders);\r\n            }\r\n            \r\n            if (path.startsWith('/file/') && request.method === 'GET') {\r\n                return await handleGetFile(request, env, corsHeaders);\r\n            }\r\n\r\n            return jsonResponse({ error: 'Not found' }, 404, corsHeaders);\r\n        } catch (error) {\r\n            console.error('Worker error:', error);\r\n            return jsonResponse({ error: error.message || 'Internal error' }, 500, corsHeaders);\r\n        }\r\n    }\r\n};\r\n\r\n// Helper: Get allowed origin for CORS\r\nfunction getAllowedOrigin(request, env) {\r\n    const origin = request.headers.get('Origin') || '';\r\n    const allowedOrigins = (env.ALLOWED_ORIGINS || '').split(',').map(o => o.trim());\r\n    \r\n    if (allowedOrigins.includes(origin) || allowedOrigins.includes('*')) {\r\n        return origin;\r\n    }\r\n    \r\n    // Default to first allowed origin or wildcard for development\r\n    return allowedOrigins[0] || '*';\r\n}\r\n\r\n// Helper: JSON response\r\nfunction jsonResponse(data, status = 200, headers = {}) {\r\n    return new Response(JSON.stringify(data), {\r\n        status,\r\n        headers: {\r\n            'Content-Type': 'application/json',\r\n            ...headers,\r\n        },\r\n    });\r\n}\r\n\r\n// Helper: Verify auth (optional - implement as needed)\r\nfunction verifyAuth(request, env) {\r\n    const authHeader = request.headers.get('Authorization');\r\n    if (!authHeader) return true; // No auth required if no secret set\r\n    \r\n    if (!env.AUTH_SECRET) return true;\r\n    \r\n    const token = authHeader.replace('Bearer ', '');\r\n    return token === env.AUTH_SECRET;\r\n}\r\n\r\n// Upload handler\r\nasync function handleUpload(request, env, corsHeaders) {\r\n    if (!verifyAuth(request, env)) {\r\n        return jsonResponse({ error: 'Unauthorized' }, 401, corsHeaders);\r\n    }\r\n\r\n    const formData = await request.formData();\r\n    const file = formData.get('file');\r\n    const customPath = formData.get('path');\r\n\r\n    if (!file) {\r\n        return jsonResponse({ error: 'No file provided' }, 400, corsHeaders);\r\n    }\r\n\r\n    // Generate unique key\r\n    const timestamp = Date.now();\r\n    const random = Math.random().toString(36).substring(7);\r\n    const extension = file.name.split('.').pop() || '';\r\n    const key = customPath || `uploads/${timestamp}_${random}.${extension}`;\r\n\r\n    // Upload to R2\r\n    await env.R2_BUCKET.put(key, file.stream(), {\r\n        httpMetadata: {\r\n            contentType: file.type,\r\n        },\r\n        customMetadata: {\r\n            originalName: file.name,\r\n            uploadedAt: new Date().toISOString(),\r\n        },\r\n    });\r\n\r\n    // Return the URL\r\n    const url = new URL(request.url);\r\n    const publicUrl = `${url.origin}/file/${encodeURIComponent(key)}`;\r\n\r\n    return jsonResponse({\r\n        success: true,\r\n        key,\r\n        url: publicUrl,\r\n        size: file.size,\r\n        type: file.type,\r\n    }, 200, corsHeaders);\r\n}\r\n\r\n// Get file handler\r\nasync function handleGetFile(request, env, corsHeaders) {\r\n    const url = new URL(request.url);\r\n    const key = decodeURIComponent(url.pathname.replace('/file/', ''));\r\n\r\n    const object = await env.R2_BUCKET.get(key);\r\n\r\n    if (!object) {\r\n        return jsonResponse({ error: 'File not found' }, 404, corsHeaders);\r\n    }\r\n\r\n    const headers = new Headers();\r\n    headers.set('Content-Type', object.httpMetadata?.contentType || 'application/octet-stream');\r\n    headers.set('Cache-Control', 'public, max-age=31536000');\r\n    headers.set('ETag', object.httpEtag);\r\n    \r\n    // Add CORS headers\r\n    Object.entries(corsHeaders).forEach(([key, value]) => {\r\n        headers.set(key, value);\r\n    });\r\n\r\n    return new Response(object.body, { headers });\r\n}\r\n\r\n// Signed URL handler\r\nasync function handleSignedUrl(request, env, corsHeaders) {\r\n    if (!verifyAuth(request, env)) {\r\n        return jsonResponse({ error: 'Unauthorized' }, 401, corsHeaders);\r\n    }\r\n\r\n    const url = new URL(request.url);\r\n    const key = url.searchParams.get('key');\r\n\r\n    if (!key) {\r\n        return jsonResponse({ error: 'Key is required' }, 400, corsHeaders);\r\n    }\r\n\r\n    // Check if object exists\r\n    const object = await env.R2_BUCKET.head(key);\r\n    if (!object) {\r\n        return jsonResponse({ error: 'File not found' }, 404, corsHeaders);\r\n    }\r\n\r\n    // Return the public URL (since we're serving through the worker)\r\n    const publicUrl = `${url.origin}/file/${encodeURIComponent(key)}`;\r\n\r\n    return jsonResponse({\r\n        url: publicUrl,\r\n        expires: null, // Our worker URLs don't expire\r\n    }, 200, corsHeaders);\r\n}\r\n\r\n// Delete handler\r\nasync function handleDelete(request, env, corsHeaders) {\r\n    if (!verifyAuth(request, env)) {\r\n        return jsonResponse({ error: 'Unauthorized' }, 401, corsHeaders);\r\n    }\r\n\r\n    const body = await request.json();\r\n    const key = body.key;\r\n\r\n    if (!key) {\r\n        return jsonResponse({ error: 'Key is required' }, 400, corsHeaders);\r\n    }\r\n\r\n    await env.R2_BUCKET.delete(key);\r\n\r\n    return jsonResponse({ success: true }, 200, corsHeaders);\r\n}\r\n\r\n// List handler\r\nasync function handleList(request, env, corsHeaders) {\r\n    if (!verifyAuth(request, env)) {\r\n        return jsonResponse({ error: 'Unauthorized' }, 401, corsHeaders);\r\n    }\r\n\r\n    const url = new URL(request.url);\r\n    const prefix = url.searchParams.get('prefix') || '';\r\n    const limit = parseInt(url.searchParams.get('limit') || '1000');\r\n\r\n    const listed = await env.R2_BUCKET.list({\r\n        prefix,\r\n        limit,\r\n    });\r\n\r\n    const objects = listed.objects.map(obj => ({\r\n        key: obj.key,\r\n        size: obj.size,\r\n        uploaded: obj.uploaded.toISOString(),\r\n        etag: obj.etag,\r\n    }));\r\n\r\n    return jsonResponse({\r\n        success: true,\r\n        objects,\r\n        truncated: listed.truncated,\r\n        cursor: listed.cursor,\r\n    }, 200, corsHeaders);\r\n}\r\n\r\n"],
  "mappings": ";;;;AA4BA,IAAO,oBAAQ;AAAA,EACX,MAAM,MAAM,SAAS,KAAK,KAAK;AAE3B,UAAM,cAAc;AAAA,MAChB,+BAA+B,iBAAiB,SAAS,GAAG;AAAA,MAC5D,gCAAgC;AAAA,MAChC,gCAAgC;AAAA,MAChC,0BAA0B;AAAA,IAC9B;AAGA,QAAI,QAAQ,WAAW,WAAW;AAC9B,aAAO,IAAI,SAAS,MAAM,EAAE,SAAS,YAAY,CAAC;AAAA,IACtD;AAEA,UAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,UAAM,OAAO,IAAI;AAEjB,QAAI;AAEA,UAAI,SAAS,aAAa,QAAQ,WAAW,QAAQ;AACjD,eAAO,MAAM,aAAa,SAAS,KAAK,WAAW;AAAA,MACvD;AAEA,UAAI,SAAS,aAAa,QAAQ,WAAW,UAAU;AACnD,eAAO,MAAM,aAAa,SAAS,KAAK,WAAW;AAAA,MACvD;AAEA,UAAI,SAAS,iBAAiB,QAAQ,WAAW,OAAO;AACpD,eAAO,MAAM,gBAAgB,SAAS,KAAK,WAAW;AAAA,MAC1D;AAEA,UAAI,SAAS,WAAW,QAAQ,WAAW,OAAO;AAC9C,eAAO,MAAM,WAAW,SAAS,KAAK,WAAW;AAAA,MACrD;AAEA,UAAI,KAAK,WAAW,QAAQ,KAAK,QAAQ,WAAW,OAAO;AACvD,eAAO,MAAM,cAAc,SAAS,KAAK,WAAW;AAAA,MACxD;AAEA,aAAO,aAAa,EAAE,OAAO,YAAY,GAAG,KAAK,WAAW;AAAA,IAChE,SAAS,OAAO;AACZ,cAAQ,MAAM,iBAAiB,KAAK;AACpC,aAAO,aAAa,EAAE,OAAO,MAAM,WAAW,iBAAiB,GAAG,KAAK,WAAW;AAAA,IACtF;AAAA,EACJ;AACJ;AAGA,SAAS,iBAAiB,SAAS,KAAK;AACpC,QAAM,SAAS,QAAQ,QAAQ,IAAI,QAAQ,KAAK;AAChD,QAAM,kBAAkB,IAAI,mBAAmB,IAAI,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC;AAE/E,MAAI,eAAe,SAAS,MAAM,KAAK,eAAe,SAAS,GAAG,GAAG;AACjE,WAAO;AAAA,EACX;AAGA,SAAO,eAAe,CAAC,KAAK;AAChC;AAVS;AAaT,SAAS,aAAa,MAAM,SAAS,KAAK,UAAU,CAAC,GAAG;AACpD,SAAO,IAAI,SAAS,KAAK,UAAU,IAAI,GAAG;AAAA,IACtC;AAAA,IACA,SAAS;AAAA,MACL,gBAAgB;AAAA,MAChB,GAAG;AAAA,IACP;AAAA,EACJ,CAAC;AACL;AARS;AAWT,SAAS,WAAW,SAAS,KAAK;AAC9B,QAAM,aAAa,QAAQ,QAAQ,IAAI,eAAe;AACtD,MAAI,CAAC,WAAY,QAAO;AAExB,MAAI,CAAC,IAAI,YAAa,QAAO;AAE7B,QAAM,QAAQ,WAAW,QAAQ,WAAW,EAAE;AAC9C,SAAO,UAAU,IAAI;AACzB;AARS;AAWT,eAAe,aAAa,SAAS,KAAK,aAAa;AACnD,MAAI,CAAC,WAAW,SAAS,GAAG,GAAG;AAC3B,WAAO,aAAa,EAAE,OAAO,eAAe,GAAG,KAAK,WAAW;AAAA,EACnE;AAEA,QAAM,WAAW,MAAM,QAAQ,SAAS;AACxC,QAAM,OAAO,SAAS,IAAI,MAAM;AAChC,QAAM,aAAa,SAAS,IAAI,MAAM;AAEtC,MAAI,CAAC,MAAM;AACP,WAAO,aAAa,EAAE,OAAO,mBAAmB,GAAG,KAAK,WAAW;AAAA,EACvE;AAGA,QAAM,YAAY,KAAK,IAAI;AAC3B,QAAM,SAAS,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,UAAU,CAAC;AACrD,QAAM,YAAY,KAAK,KAAK,MAAM,GAAG,EAAE,IAAI,KAAK;AAChD,QAAM,MAAM,cAAc,WAAW,SAAS,IAAI,MAAM,IAAI,SAAS;AAGrE,QAAM,IAAI,UAAU,IAAI,KAAK,KAAK,OAAO,GAAG;AAAA,IACxC,cAAc;AAAA,MACV,aAAa,KAAK;AAAA,IACtB;AAAA,IACA,gBAAgB;AAAA,MACZ,cAAc,KAAK;AAAA,MACnB,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,IACvC;AAAA,EACJ,CAAC;AAGD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,YAAY,GAAG,IAAI,MAAM,SAAS,mBAAmB,GAAG,CAAC;AAE/D,SAAO,aAAa;AAAA,IAChB,SAAS;AAAA,IACT;AAAA,IACA,KAAK;AAAA,IACL,MAAM,KAAK;AAAA,IACX,MAAM,KAAK;AAAA,EACf,GAAG,KAAK,WAAW;AACvB;AAzCe;AA4Cf,eAAe,cAAc,SAAS,KAAK,aAAa;AACpD,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,MAAM,mBAAmB,IAAI,SAAS,QAAQ,UAAU,EAAE,CAAC;AAEjE,QAAM,SAAS,MAAM,IAAI,UAAU,IAAI,GAAG;AAE1C,MAAI,CAAC,QAAQ;AACT,WAAO,aAAa,EAAE,OAAO,iBAAiB,GAAG,KAAK,WAAW;AAAA,EACrE;AAEA,QAAM,UAAU,IAAI,QAAQ;AAC5B,UAAQ,IAAI,gBAAgB,OAAO,cAAc,eAAe,0BAA0B;AAC1F,UAAQ,IAAI,iBAAiB,0BAA0B;AACvD,UAAQ,IAAI,QAAQ,OAAO,QAAQ;AAGnC,SAAO,QAAQ,WAAW,EAAE,QAAQ,CAAC,CAACA,MAAK,KAAK,MAAM;AAClD,YAAQ,IAAIA,MAAK,KAAK;AAAA,EAC1B,CAAC;AAED,SAAO,IAAI,SAAS,OAAO,MAAM,EAAE,QAAQ,CAAC;AAChD;AArBe;AAwBf,eAAe,gBAAgB,SAAS,KAAK,aAAa;AACtD,MAAI,CAAC,WAAW,SAAS,GAAG,GAAG;AAC3B,WAAO,aAAa,EAAE,OAAO,eAAe,GAAG,KAAK,WAAW;AAAA,EACnE;AAEA,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,MAAM,IAAI,aAAa,IAAI,KAAK;AAEtC,MAAI,CAAC,KAAK;AACN,WAAO,aAAa,EAAE,OAAO,kBAAkB,GAAG,KAAK,WAAW;AAAA,EACtE;AAGA,QAAM,SAAS,MAAM,IAAI,UAAU,KAAK,GAAG;AAC3C,MAAI,CAAC,QAAQ;AACT,WAAO,aAAa,EAAE,OAAO,iBAAiB,GAAG,KAAK,WAAW;AAAA,EACrE;AAGA,QAAM,YAAY,GAAG,IAAI,MAAM,SAAS,mBAAmB,GAAG,CAAC;AAE/D,SAAO,aAAa;AAAA,IAChB,KAAK;AAAA,IACL,SAAS;AAAA;AAAA,EACb,GAAG,KAAK,WAAW;AACvB;AAzBe;AA4Bf,eAAe,aAAa,SAAS,KAAK,aAAa;AACnD,MAAI,CAAC,WAAW,SAAS,GAAG,GAAG;AAC3B,WAAO,aAAa,EAAE,OAAO,eAAe,GAAG,KAAK,WAAW;AAAA,EACnE;AAEA,QAAM,OAAO,MAAM,QAAQ,KAAK;AAChC,QAAM,MAAM,KAAK;AAEjB,MAAI,CAAC,KAAK;AACN,WAAO,aAAa,EAAE,OAAO,kBAAkB,GAAG,KAAK,WAAW;AAAA,EACtE;AAEA,QAAM,IAAI,UAAU,OAAO,GAAG;AAE9B,SAAO,aAAa,EAAE,SAAS,KAAK,GAAG,KAAK,WAAW;AAC3D;AAfe;AAkBf,eAAe,WAAW,SAAS,KAAK,aAAa;AACjD,MAAI,CAAC,WAAW,SAAS,GAAG,GAAG;AAC3B,WAAO,aAAa,EAAE,OAAO,eAAe,GAAG,KAAK,WAAW;AAAA,EACnE;AAEA,QAAM,MAAM,IAAI,IAAI,QAAQ,GAAG;AAC/B,QAAM,SAAS,IAAI,aAAa,IAAI,QAAQ,KAAK;AACjD,QAAM,QAAQ,SAAS,IAAI,aAAa,IAAI,OAAO,KAAK,MAAM;AAE9D,QAAM,SAAS,MAAM,IAAI,UAAU,KAAK;AAAA,IACpC;AAAA,IACA;AAAA,EACJ,CAAC;AAED,QAAM,UAAU,OAAO,QAAQ,IAAI,UAAQ;AAAA,IACvC,KAAK,IAAI;AAAA,IACT,MAAM,IAAI;AAAA,IACV,UAAU,IAAI,SAAS,YAAY;AAAA,IACnC,MAAM,IAAI;AAAA,EACd,EAAE;AAEF,SAAO,aAAa;AAAA,IAChB,SAAS;AAAA,IACT;AAAA,IACA,WAAW,OAAO;AAAA,IAClB,QAAQ,OAAO;AAAA,EACnB,GAAG,KAAK,WAAW;AACvB;AA3Be;",
  "names": ["key"]
}
